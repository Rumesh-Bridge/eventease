{% extends "admin/base_admin.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Admin Dashboard</h1>
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createEventModal">
        Create New Event
    </button>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3 class="mb-0">Event Management</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Location</th>
                        <th>Date & Time</th>
                        <th>Seats (Available/Total)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <tr>
                        <td colspan="5" class="text-center">Loading events...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="mb-0">All Bookings</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Event Title</th>
                        <th>User Email</th>
                        <th>Seats</th>
                        <th>Booking Time</th>
                    </tr>
                </thead>
                <tbody id="bookings-table-body">
                    <tr>
                        <td colspan="5" class="text-center">Loading bookings...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="modal fade" id="createEventModal" tabindex="-1" aria-labelledby="createEventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createEventModalLabel">Create New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="create-event-form">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="date_time" class="form-label">Date & Time</label>
                            <input type="datetime-local" class="form-control" id="date_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="total_seats" class="form-label">Total Seats</label>
                            <input type="number" class="form-control" id="total_seats" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="3"></textarea>
                    </div>
                    <div id="modal-error-message" class="alert alert-danger" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary" form="create-event-form">Create Event</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // This script runs when the page is loaded
    document.addEventListener("DOMContentLoaded", function() {
        const token = getAuthToken();
        if (!token) {
            // If no token, redirect to login
            window.location.href = "/admin/login/";
            return;
        }

        // Load all the data for the dashboard
        loadEvents();
        loadBookings();

        // Add listener for the create event form
        document.getElementById("create-event-form").addEventListener("submit", handleCreateEvent);
    });

    // --- FUNCTIONS TO LOAD DATA ---

    async function loadEvents() {
        const eventsTbody = document.getElementById("events-table-body");
        try {
            // This API is public, no token needed, but actions will require it
            const response = await fetch("/api/events/");
            if (!response.ok) throw new Error("Failed to fetch events");
            
            const events = await response.json();
            eventsTbody.innerHTML = ""; // Clear loading message

            if (events.length === 0) {
                eventsTbody.innerHTML = '<tr><td colspan="5" class="text-center">No events found.</td></tr>';
                return;
            }

            events.forEach(event => {
                const eventTime = new Date(event.date_time).toLocaleString('en-US');
                const row = `
                    <tr>
                        <td>${event.title}</td>
                        <td>${event.location}</td>
                        <td>${eventTime}</td>
                        <td>${event.available_seats} / ${event.total_seats}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})">Delete</button>
                        </td>
                    </tr>
                `;
                eventsTbody.innerHTML += row;
            });

        } catch (error) {
            eventsTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    async function loadBookings() {
        const bookingsTbody = document.getElementById("bookings-table-body");
        const token = getAuthToken();

        try {
            const response = await fetch("/api/bookings/all/", {
                headers: { "Authorization": "Bearer " + token }
            });
            
            if (!response.ok) {
                // This will catch 401/403 errors
                handleAuthError(response);
                throw new Error("Could not fetch bookings.");
            }
            
            const bookings = await response.json();
            bookingsTbody.innerHTML = ""; // Clear loading message

            if (bookings.length === 0) {
                bookingsTbody.innerHTML = '<tr><td colspan="5" class="text-center">No bookings found.</td></tr>';
                return;
            }

            bookings.forEach(booking => {
                const bookingTime = new Date(booking.booking_time).toLocaleString('en-US');
                const row = `
                    <tr>
                        <td>${booking.id}</td>
                        <td>${booking.event.title}</td>
                        <td>${booking.user_id}</td> <td>${booking.number_of_seats}</td>
                        <td>${bookingTime}</td>
                    </tr>
                `;
                bookingsTbody.innerHTML += row;
            });

        } catch (error) {
            bookingsTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    // --- FUNCTIONS TO PERFORM ACTIONS ---

    async function handleCreateEvent(event) {
        event.preventDefault();
        const token = getAuthToken();
        const errorEl = document.getElementById("modal-error-message");

        const eventData = {
            title: document.getElementById("title").value,
            location: document.getElementById("location").value,
            date_time: document.getElementById("date_time").value,
            total_seats: parseInt(document.getElementById("total_seats").value),
            description: document.getElementById("description").value,
        };

        try {
            const response = await fetch("/api/events/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify(eventData)
            });

            const data = await response.json();
            
            if (!response.ok) {
                handleAuthError(response);
                throw new Error(data.detail || "Failed to create event");
            }

            // Success!
            bootstrap.Modal.getInstance(document.getElementById('createEventModal')).hide(); // Close modal
            document.getElementById("create-event-form").reset(); // Reset form
            loadEvents(); // Refresh the events table
            
        } catch (error) {
            errorEl.textContent = error.message;
            errorEl.style.display = "block";
        }
    }

    async function deleteEvent(eventId) {
        if (!confirm("Are you sure you want to delete this event? This is permanent.")) {
            return;
        }

        const token = getAuthToken();
        
        try {
            const response = await fetch(`/api/events/${eventId}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });

            if (!response.ok) {
                handleAuthError(response);
                const data = await response.json();
                throw new Error(data.detail || "Failed to delete event");
            }

            // Success!
            loadEvents(); // Refresh the events table

        } catch (error) {
            alert(error.message);
        }
    }
</script>
{% endblock %}