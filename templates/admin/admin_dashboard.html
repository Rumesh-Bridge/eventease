{% extends "admin/base_admin.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="display-5">Admin Dashboard</h1>
    
    <a href="/admin/events/new/" class="btn btn-primary btn-lg">
        Create New Event
    </a>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h3 class="mb-0">Event Management</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Location</th>
                        <th>Date & Time</th>
                        <th>Seats (Available/Total)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="events-table-body">
                    <tr><td colspan="5" class="text-center">Loading events...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h3 class="mb-0">All Bookings</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Event Title</th>
                        <th>User Email</th>
                        <th>Seats</th>
                        <th>Booking Time</th>
                    </tr>
                </thead>
                <tbody id="bookings-table-body">
                    <tr><td colspan="5" class="text-center">Loading bookings...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>
    // This script runs when the page is loaded
    document.addEventListener("DOMContentLoaded", function() {
        const token = getAuthToken();
        if (!token) {
            window.location.href = "/admin/login/";
            return;
        }
        loadEvents();
        loadBookings();
    });

    // --- FUNCTIONS TO LOAD DATA ---

    async function loadEvents() {
        const eventsTbody = document.getElementById("events-table-body");
        try {
            const response = await fetch("/api/events/");
            if (!response.ok) throw new Error("Failed to fetch events");
            
            const events = await response.json();
            eventsTbody.innerHTML = ""; 

            if (events.length === 0) {
                eventsTbody.innerHTML = '<tr><td colspan="5" class="text-center">No events found.</td></tr>';
                return;
            }

            events.forEach(event => {
                const eventTime = new Date(event.date_time).toLocaleString('en-US');
                const row = `
                    <tr>
                        <td>${event.title}</td>
                        <td>${event.location}</td>
                        <td>${eventTime}</td>
                        <td>${event.available_seats} / ${event.total_seats}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})">Delete</button>
                        </td>
                    </tr>
                `;
                eventsTbody.innerHTML += row;
            });

        } catch (error) {
            eventsTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    async function loadBookings() {
        const bookingsTbody = document.getElementById("bookings-table-body");
        const token = getAuthToken();
        try {
            const response = await fetch("/api/bookings/all/", {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) {
                handleAuthError(response);
                throw new Error("Could not fetch bookings.");
            }
            const bookings = await response.json();
            bookingsTbody.innerHTML = ""; 
            if (bookings.length === 0) {
                bookingsTbody.innerHTML = '<tr><td colspan="5" class="text-center">No bookings found.</td></tr>';
                return;
            }
            bookings.forEach(booking => {
                const bookingTime = new Date(booking.booking_time).toLocaleString('en-US');
                const row = `
                    <tr>
                        <td>${booking.id}</td>
                        <td>${booking.event.title}</td>
                        <td>${booking.user.email}</td>
                        <td>${booking.number_of_seats}</td>
                        <td>${bookingTime}</td>
                    </tr>
                `;
                bookingsTbody.innerHTML += row;
            });
        } catch (error) {
            bookingsTbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }

    // --- FUNCTIONS TO PERFORM ACTIONS ---

    async function deleteEvent(eventId) {
        if (!confirm("Are you sure you want to delete this event?")) return;
        const token = getAuthToken();
        try {
            const response = await fetch(`/api/events/${eventId}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            if (!response.ok) {
                handleAuthError(response);
                const data = await response.json();
                throw new Error(data.detail || "Failed to delete event");
            }
            loadEvents(); // Refresh table
        } catch (error) {
            alert(error.message);
        }
    }
</script>
{% endblock %}